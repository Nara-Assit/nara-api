// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum RoleType {
  DEAF
  MUTE
  COCHLEAR_IMPLANT
  PARENT
  SPECIALIST
  DOCTOR
}

enum NotificationType {
  SYSTEM
  CHAT
  SESSION
  TRAINING
}

enum OtpType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum ChatType {
  PRIVATE
  GROUP
}

enum ChatRole {
  ADMIN
  MEMBER
}

model User {
  id                 Int      @id @default(autoincrement())
  name               String   @db.VarChar(50)
  profileImageUrl    String?  @db.VarChar(255)
  email              String   @unique @db.VarChar(255)
  phoneNumber        String?  @unique @db.VarChar(15)
  passwordHash       String   @db.VarChar(255)
  createdAt          DateTime @default(now())
  isVerified         Boolean  @default(false)
  country            String   @db.VarChar(50)
  age                Int      @db.SmallInt
  closeContactNumber String   @db.VarChar(15)
  lastActiveAt       DateTime @default(now())

  role              RoleType
  refreshTokens     RefreshToken[]
  otpCodes          OtpCode[]
  notifications     Notification[]
  fcmTokens         FcmToken[]
  userNotifications UserNotification[]
  messages          Message[]
  chats             UserChat[]
  blockedUsers      UserBlock[]        @relation("Blocker")
  blockedByUsers    UserBlock[]        @relation("Blocked")

  @@index([id])
  @@index([email])
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model OtpCode {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  type      OtpType
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([code])
  @@index([userId, type])
}

model FcmToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model Notification {
  id                Int                @id @default(autoincrement())
  payload           Json
  createdAt         DateTime           @default(now())
  userNotifications UserNotification[]
  user              User?              @relation(fields: [userId], references: [id])
  userId            Int?
}

model UserNotification {
  userId         Int
  notificationId Int
  read           Boolean @default(false)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@id([userId, notificationId])
  @@index([notificationId])
  @@index([userId])
}

model Chat {
  id           Int        @id @default(autoincrement())
  type         ChatType
  createdAt    DateTime   @default(now())
  lastActivity DateTime   @default(now())
  name         String?    @db.VarChar(50)
  description  String?    @db.VarChar(1024)
  avatarUrl    String?    @db.VarChar(255)
  messages     Message[]
  members      UserChat[]

  @@index([lastActivity])
}

model Message {
  id        Int      @id @default(autoincrement())
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId  Int
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId    Int
  text      String   @db.Text
  createdAt DateTime @default(now())

  @@index([senderId])
  @@index([chatId])
}

model UserChat {
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  chat       Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId     Int
  joinedAt   DateTime @default(now())
  role       ChatRole
  isFavorite Boolean  @default(false)

  @@id([userId, chatId])
  @@index([chatId])
}

model UserBlock {
  blockerId Int
  blockedId Int
  createdAt DateTime @default(now())

  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@id([blockerId, blockedId])
  @@index([blockedId])
  @@index([blockerId])
}
